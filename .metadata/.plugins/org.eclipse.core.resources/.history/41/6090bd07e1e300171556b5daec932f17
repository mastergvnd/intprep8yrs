package com.essbase.japi;

import java.io.IOException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.HashMap;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.Queue;

import com.essbase.api.base.EssException;
import com.essbase.api.base.IEssBaseObject;
import com.essbase.api.metadata.IEssCubeOutline;
import com.essbase.api.metadata.IEssDimension;
import com.essbase.api.metadata.IEssMember;

public class EssBaseUtil {
		
	private static void readMember(List<IEssDimension> sDimensionsList, List<IEssDimension> tDimensionsList, int sIndentation, int tIndentation){
		if(sDimensionsList == null){
			for(IEssDimension dimention : tDimensionsList){
				Writer.write(null, dimention.getName(), sIndentation, tIndentation+4);
				IEssBaseObject[] tMembers = sDimensionsList.get(i).getDimensionRootMember().getChildMembers().getAll();
				for(int j = 0; j<tMembers.length; j++){
					IEssMember tMember = (IEssMember) tMembers[j];
					//System.out.println("\t"+sMember.getName()+"\t\t\t\t\t"+tMember.getName());
					Writer.write(null, tMember.getName(), sIndentation, tIndentation+4);
					readSubMemersNew(null, tMember, sIndentation+4, tIndentation+4);
				}
			}
		}else{
			
		}
		int i;
		for(i = 0; i<memLength ; i++){
		
		}
		if(sDimensionsList.size() < tDimensionsList.size())
			readMembers(tDimensionsList);
		else
			readMembers(sDimensionsList);
	}
	
	public static void readSubMembers(IEssMember sMember, IEssMember tMember, int sIndentation, int tIndentation) throws EssException, IOException {
		IEssBaseObject[] members = null;
		if(sMember != null){
			members = sMember.getChildMembers().getAll();
			for(int i = 0; i<members.length; i++){
				IEssMember subMember = (IEssMember) members[i];
				//System.out.println(alignment+subMember.getName());
				Writer.write(subMember.getName(), "", sIndentation+4, 0);
				readSubMembers(subMember, null, sIndentation+4, tIndentation);
			}
		}
		else{
			members = tMember.getChildMembers().getAll();
			for(int i = 0; i<members.length; i++){
				IEssMember subMember = (IEssMember) members[i];
				//System.out.println(alignment+subMember.getName());
				Writer.write(null, subMember.getName(), sIndentation, tIndentation+4);
				readSubMembers(null, subMember, sIndentation, tIndentation+4);
			}
		}
	}

	public static List<IEssDimension> readDimensionsAsList(IEssCubeOutline cubeOutLine) throws EssException{
		List<IEssDimension> dimenionsList = new ArrayList<IEssDimension>();
		IEssBaseObject[] dimensions = cubeOutLine.getDimensions().getAll();
		for(int i = 0; i<dimensions.length; i++){
			IEssDimension dimension = (IEssDimension) dimensions[i];
			dimenionsList.add(dimension);
		}
		return dimenionsList;
	}
	
	public static Map<String, IEssDimension> readDimensionsAsMap(IEssCubeOutline cubeOutLine) throws EssException{
		Map<String, IEssDimension> dimenionsList = new LinkedHashMap<String, IEssDimension>();
		IEssBaseObject[] dimensions = cubeOutLine.getDimensions().getAll();
		for(int i = 0; i<dimensions.length; i++){
			IEssDimension dimension = (IEssDimension) dimensions[i];
			dimenionsList.put(dimension.getName(), dimension);
		}
		return dimenionsList;
	}

	public static void cubeComparator(EssBaseCube sourceCube, EssBaseCube targetCube) throws EssException, IOException {
		Map<String, IEssDimension> sourceDimensinMap = readDimensionsAsMap(sourceCube.getCubeOutline());
		Map<String, IEssDimension> targetDimensinMap = readDimensionsAsMap(targetCube.getCubeOutline());
		Writer.write("Source Cube Name : "+sourceCube.getCubeName(), Writer.NEW_LINE);
		//writer.append("Source Cube Name : "+sourceCube.getCubeName()+System.lineSeparator());
		//writer.append("Target Cube Name : "+targetCube.getCubeName()+System.lineSeparator());
		Writer.write("Target Cube Name : "+targetCube.getCubeName(), Writer.NEW_LINE);
		findDimensionDifferences(sourceDimensinMap, targetDimensinMap);
	}

	private static void findDimensionDifferences(Map<String, IEssDimension> sDimensionMap,
			Map<String, IEssDimension> tDimensionMap) throws EssException, IOException {
		System.out.println("Number of dimensions in source cube: " + sDimensionMap.size());
		System.out.println("Number of dimensions in target cube: " + tDimensionMap.size());	
		Writer.write("Number of dimensions in source cube: "+sDimensionMap.size(), Writer.NEW_LINE);
		Writer.write("Number of dimensions in target cube: "+tDimensionMap.size(), Writer.NEW_LINE);
		//writer.append("Number of dimensions in source cube: "+sDimensionMap.size()+System.lineSeparator());
		//writer.append("Number of dimensions in target cube: "+tDimensionMap.size()+System.lineSeparator());
		for(String dName : sDimensionMap.keySet()){
			if(tDimensionMap.containsKey(dName)){
				checkforDimensionProperties(sDimensionMap.get(dName), tDimensionMap.get(dName));
			}else{
				Writer.write("Dimension is missing in target cube,"+dName, Writer.NEW_LINE);
				//writer.append("Dimension is missing in target cube,"+dName+System.lineSeparator());
			}
		}
		print(sDimensionMap, tDimensionMap);
	}
	
	public static void readSubMembersNew(IEssMember sMember, IEssMember tMember,int sIndentation, int tIndentation) throws EssException, IOException {
		IEssBaseObject[] sMembers = sMember.getChildMembers().getAll();
		IEssBaseObject[] tMembers = tMember.getChildMembers().getAll();
		int subMemLength = sMembers.length > tMembers.length ? sMembers.length : tMembers.length;
		for(int i = 0; i<subMemLength; i++){
			IEssMember sSubMember = (IEssMember) sMembers[i];
			IEssMember tSubMember = (IEssMember) tMembers[i];
//			System.out.println(alignment1+sSubMember.getName()+alignment2+tSubMember.getName());
			Writer.write(sSubMember.getName(), tSubMember.getName(), sIndentation+4, tIndentation+4);
			readSubMembersNew(tSubMember, tSubMember, sIndentation+4, tIndentation+4);
		}
		if(sMembers.length < tMembers.length)
			readSubMembers(null, tMember, 0, tIndentation+4);
		else
			readSubMembers(sMember, null, sIndentation+4, 0);
	}
	
	public static void readMembersNew(List<IEssDimension> sDimensionsList, List<IEssDimension> tDimensionsList) throws EssException, IOException {
		
		int memLength = sDimensionsList.size() < tDimensionsList.size() ? sDimensionsList.size() : tDimensionsList.size();
		int i;
		int sIndentation =0;
		int tIndentation =0;
		for(i = 0; i<memLength ; i++){
			IEssBaseObject[] sMembers = sDimensionsList.get(i).getDimensionRootMember().getChildMembers().getAll();
			IEssBaseObject[] tMembers = sDimensionsList.get(i).getDimensionRootMember().getChildMembers().getAll();
			int subMemLength = sMembers.length > tMembers.length ? sMembers.length : tMembers.length;
			//System.out.println(sDimensionsList.get(i).getName()+"\t\t\t\t"+tDimensionsList.get(i).getName());
			Writer.write(sDimensionsList.get(i).getName(), tDimensionsList.get(i).getName(), sIndentation, tIndentation);
			for(int j = 0; j<subMemLength; j++){
				IEssMember sMember = (IEssMember) sMembers[j];
				IEssMember tMember = (IEssMember) tMembers[j];
				//System.out.println("\t"+sMember.getName()+"\t\t\t\t\t"+tMember.getName());
				Writer.write(sMember.getName(), tMember.getName(), sIndentation+4, tIndentation+4);
				readSubMembersNew(sMember, tMember, sIndentation+4, tIndentation+4);
			}
		}
		if(sDimensionsList.size() < tDimensionsList.size())
			readMembers(null , tDimensionsList, sIndentation, tIndentation);
		else
			readMembers(sDimensionsList, null, sIndentation, tIndentation);
	}

	
	private static void print(Map<String, IEssDimension> sDimensionMap, Map<String, IEssDimension> tDimensionMap) throws EssException, IOException {
		List<IEssDimension> sList = new ArrayList<IEssDimension>(sDimensionMap.values());
		List<IEssDimension> tList = new ArrayList<IEssDimension>(tDimensionMap.values());
		readMembersNew(sList, tList);
	}
}